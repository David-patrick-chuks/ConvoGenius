Refactor chatController.ts with improved message handling
